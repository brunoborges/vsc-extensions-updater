name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 02:00 UTC to catch dependency issues
    - cron: '0 2 * * 0'

# Permissions needed for test reporting
permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

env:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"

jobs:
  test:
    name: Test on ${{ matrix.os }} with Java ${{ matrix.java }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: [21, 25]
        include:
          - os: ubuntu-latest
            display-name: "Linux"
          - os: windows-latest
            display-name: "Windows"
          - os: macos-latest
            display-name: "macOS"
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java }}
        distribution: 'temurin'
        cache: maven
        
    - name: Validate Maven project
      run: mvn validate
      
    - name: Compile project
      run: mvn clean compile
      
    - name: Run tests
      run: mvn test
      
    - name: Generate test report
      if: always()
      shell: bash
      run: |
        echo "## Test Results for ${{ matrix.display-name }} - Java ${{ matrix.java }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "target/surefire-reports" ] && [ "$(ls -A target/surefire-reports/*.xml 2>/dev/null)" ]; then
          # Parse test results from XML
          TOTAL_TESTS=$(grep -r "tests=" target/surefire-reports/TEST-*.xml | head -1 | sed 's/.*tests="\([0-9]*\)".*/\1/')
          FAILED_TESTS=$(grep -r "failures=" target/surefire-reports/TEST-*.xml | head -1 | sed 's/.*failures="\([0-9]*\)".*/\1/')
          ERROR_TESTS=$(grep -r "errors=" target/surefire-reports/TEST-*.xml | head -1 | sed 's/.*errors="\([0-9]*\)".*/\1/')
          SKIPPED_TESTS=$(grep -r "skipped=" target/surefire-reports/TEST-*.xml | head -1 | sed 's/.*skipped="\([0-9]*\)".*/\1/')
          
          # Default to 0 if parsing fails
          TOTAL_TESTS=${TOTAL_TESTS:-0}
          FAILED_TESTS=${FAILED_TESTS:-0}
          ERROR_TESTS=${ERROR_TESTS:-0}
          SKIPPED_TESTS=${SKIPPED_TESTS:-0}
          
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS - ERROR_TESTS - SKIPPED_TESTS))
          
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | $PASSED_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | $FAILED_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš« Errors | $ERROR_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ Skipped | $SKIPPED_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FAILED_TESTS" -gt 0 ] || [ "$ERROR_TESTS" -gt 0 ]; then
            echo "âŒ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Tests:" >> $GITHUB_STEP_SUMMARY
            grep -l "failure\|error" target/surefire-reports/TEST-*.xml 2>/dev/null | while read file; do
              echo "- $(basename "$file" .xml | sed 's/TEST-//')" >> $GITHUB_STEP_SUMMARY
            done || echo "- Check test artifacts for details" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **All tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âš ï¸ **No test results found**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-java${{ matrix.java }}
        path: |
          target/surefire-reports/
          target/test-classes/
        retention-days: 30

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Build application JAR
      run: mvn clean package -DskipTests
      
    - name: Verify JAR executable
      run: |
        echo "Checking if JAR is executable..."
        ls -la target/extension-updater-*.jar
        java -jar target/extension-updater-*.jar --version || echo "Version check completed"
        
    - name: Upload application artifact
      uses: actions/upload-artifact@v4
      with:
        name: application-jar
        path: target/extension-updater-*.jar
        retention-days: 90

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Run Maven verify (includes all checks)
      run: mvn clean verify -DskipTests
      
    - name: Check for dependency vulnerabilities
      run: |
        mvn org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=7 || echo "Dependency check completed with warnings"
        
    - name: Upload dependency check report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: target/dependency-check-report.html
        retention-days: 30

  dependency-analysis:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Analyze dependencies
      run: |
        echo "Generating dependency tree..."
        mvn dependency:tree > dependency-tree.txt
        
        echo "Checking for dependency conflicts..."
        mvn dependency:analyze-duplicate > dependency-duplicates.txt || true
        
        echo "Checking for unused dependencies..."
        mvn dependency:analyze > dependency-analysis.txt || true
        
    - name: Upload dependency analysis
      uses: actions/upload-artifact@v4
      with:
        name: dependency-analysis
        path: |
          dependency-tree.txt
          dependency-duplicates.txt
          dependency-analysis.txt
        retention-days: 30

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [test, build, code-quality, dependency-analysis]
    if: always()
    
    steps:
    - name: Create build summary
      run: |
        echo "# Build and Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- Cross-platform tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Results" >> $GITHUB_STEP_SUMMARY
        echo "- Application build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Code quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Dependency analysis: ${{ needs.dependency-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Application JAR: Available in artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Test reports: Available in artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Dependency analysis: Available in artifacts" >> $GITHUB_STEP_SUMMARY
        
        # Set overall status
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.build.result }}" == "success" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Overall Status: SUCCESS**" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Overall Status: FAILED**" >> $GITHUB_STEP_SUMMARY
        fi