name: macOS Installer

on:
  push:
    tags: ['v*']
  workflow_dispatch:
  pull_request:
    branches: ['main']
    paths:
      - 'src/main/macos/**'
      - 'pom.xml'
      - '.github/workflows/macos-installer.yml'

jobs:
  build-macos-installer:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-m2-
          
    - name: Validate jlink availability
      run: |
        java -version
        jlink --version
        echo "JAVA_HOME: $JAVA_HOME"
        ls -la "$JAVA_HOME/jmods" | head -10
        
    - name: Import signing certificates (for releases)
      if: startsWith(github.ref, 'refs/tags/') && github.event_name != 'pull_request'
      env:
        SIGNING_CERTIFICATE_P12_DATA: ${{ secrets.SIGNING_CERTIFICATE_P12_DATA }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
      run: |
        echo $SIGNING_CERTIFICATE_P12_DATA | base64 --decode > certificate.p12
        security create-keychain -p temp_password temp.keychain
        security default-keychain -s temp.keychain
        security unlock-keychain -p temp_password temp.keychain
        security import certificate.p12 -k temp.keychain -P $SIGNING_CERTIFICATE_PASSWORD -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k temp_password temp.keychain
        
    - name: Set up notarization credentials (for releases)
      if: startsWith(github.ref, 'refs/tags/') && github.event_name != 'pull_request'
      env:
        NOTARIZATION_USERNAME: ${{ secrets.NOTARIZATION_USERNAME }}
        NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
        NOTARIZATION_TEAM_ID: ${{ secrets.NOTARIZATION_TEAM_ID }}
      run: |
        xcrun notarytool store-credentials "vscode-updater-notarization" \
          --apple-id "$NOTARIZATION_USERNAME" \
          --password "$NOTARIZATION_PASSWORD" \
          --team-id "$NOTARIZATION_TEAM_ID"
          
    - name: Build application JAR
      run: mvn clean package -DskipTests
      
    - name: Make build script executable
      run: chmod +x build-macos-installer.sh
      
    - name: Build macOS installer (unsigned for PR)
      if: github.event_name == 'pull_request'
      run: ./build-macos-installer.sh
          
    - name: Build macOS installer (signed for release)
      if: startsWith(github.ref, 'refs/tags/') && github.event_name != 'pull_request'
      env:
        MAC_SIGNING_IDENTITY: "Developer ID Application: Bruno Borges"
        MAC_NOTARIZATION_PROFILE: "vscode-updater-notarization"
      run: ./build-macos-installer.sh
          
    - name: Verify installer package
      run: |
        ls -la target/installer/
        if [ -f target/installer/*.pkg ]; then
          echo "Installer package created successfully"
          pkgutil --check-signature target/installer/*.pkg || echo "Package not signed (expected for PR builds)"
          du -sh target/installer/*.pkg
        else
          echo "ERROR: No installer package found"
          exit 1
        fi
        
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-installer-${{ github.run_id }}
        path: target/installer/*.pkg
        retention-days: 30
        
    - name: Release
      if: startsWith(github.ref, 'refs/tags/') && github.event_name != 'pull_request'
      uses: softprops/action-gh-release@v2
      with:
        files: target/installer/*.pkg
        body: |
          ## macOS Installer Package
          
          This release includes a self-contained macOS installer package with embedded Java Runtime.
          
          ### Installation
          1. Download the `.pkg` file
          2. Double-click to install
          3. The application will automatically start and appear in your menu bar
          
          ### Features
          - ✅ No Java installation required
          - ✅ Automatic startup configuration
          - ✅ Native macOS integration
          - ✅ Code signed and notarized
          
          ### System Requirements
          - macOS 10.15 (Catalina) or later
          - Intel or Apple Silicon Mac