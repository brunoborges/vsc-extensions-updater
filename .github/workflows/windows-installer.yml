name: Windows Installer

on:
  push:
    tags: ['v*']
  workflow_dispatch:
  pull_request:
    branches: ['main']
    paths:
      - 'src/main/windows/**'
      - 'build-windows-installer.ps1'
      - 'pom.xml'
      - '.github/workflows/windows-installer.yml'

# Permissions for artifact uploads and releases
permissions:
  contents: write
  actions: read

env:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"

jobs:
  build-windows-installer:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~\.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-m2-
          
    - name: Validate jlink and jpackage availability
      run: |
        java -version
        jlink --version
        jpackage --version
        Write-Host "JAVA_HOME: $env:JAVA_HOME"
        Get-ChildItem "$env:JAVA_HOME\jmods" | Select-Object -First 10
      shell: pwsh
        
    - name: Set up code signing certificate (for releases)
      if: startsWith(github.ref, 'refs/tags/') && github.event_name != 'pull_request'
      env:
        WIN_SIGNING_CERTIFICATE: ${{ secrets.WIN_SIGNING_CERTIFICATE }}
        WIN_SIGNING_PASSWORD: ${{ secrets.WIN_SIGNING_PASSWORD }}
      run: |
        if ($env:WIN_SIGNING_CERTIFICATE) {
          Write-Host "âœ… Code signing certificate configured" -ForegroundColor Green
        } else {
          Write-Host "âš ï¸  No code signing certificate provided" -ForegroundColor Yellow
        }
      shell: pwsh
        
    - name: Build application JAR
      run: mvn clean package -DskipTests
      
    - name: Build Windows installer (unsigned for PR/manual)
      if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
      run: |
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
        .\build-windows-installer.ps1
      shell: pwsh
          
    - name: Build Windows installer (signed for release)
      if: startsWith(github.ref, 'refs/tags/') && github.event_name != 'pull_request' && github.event_name != 'workflow_dispatch'
      env:
        WIN_SIGNING_CERTIFICATE: ${{ secrets.WIN_SIGNING_CERTIFICATE }}
        WIN_SIGNING_PASSWORD: ${{ secrets.WIN_SIGNING_PASSWORD }}
      run: |
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
        .\build-windows-installer.ps1
      shell: pwsh
          
    - name: Verify installer package
      run: |
        Get-ChildItem target\installer\ -Recurse
        $msiFile = Get-ChildItem -Path "target\installer\" -Filter "*.msi" | Select-Object -First 1
        if ($msiFile) {
          Write-Host "âœ… Installer package created successfully" -ForegroundColor Green
          Write-Host "ðŸ“¦ File: $($msiFile.FullName)" -ForegroundColor Blue
          Write-Host "ðŸ“ Size: $([math]::Round(($msiFile.Length / 1MB), 1)) MB" -ForegroundColor Blue
          
          # Basic MSI validation
          try {
            $msiInfo = Get-ItemProperty -Path $msiFile.FullName
            Write-Host "âœ… MSI file appears valid" -ForegroundColor Green
          } catch {
            Write-Host "âš ï¸  MSI validation warning: $($_.Exception.Message)" -ForegroundColor Yellow
          }
          
          # Check digital signature if this is a release build
          if ($env:WIN_SIGNING_CERTIFICATE) {
            try {
              $signature = Get-AuthenticodeSignature -FilePath $msiFile.FullName
              Write-Host "ðŸ” Signature Status: $($signature.Status)" -ForegroundColor Blue
              Write-Host "ðŸ” Signature Subject: $($signature.SignerCertificate.Subject)" -ForegroundColor Blue
            } catch {
              Write-Host "âš ï¸  Could not verify signature: $($_.Exception.Message)" -ForegroundColor Yellow
            }
          }
        } else {
          Write-Host "âŒ ERROR: No installer package found" -ForegroundColor Red
          exit 1
        }
      shell: pwsh
      env:
        WIN_SIGNING_CERTIFICATE: ${{ secrets.WIN_SIGNING_CERTIFICATE }}
        
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer-${{ github.run_id }}
        path: target/installer/*.msi
        retention-days: 30
        
    - name: Generate installer summary
      if: always()
      shell: pwsh
      run: |
        $msiFile = Get-ChildItem -Path "target\installer\" -Filter "*.msi" -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if ($msiFile) {
          $sizeInMB = [math]::Round(($msiFile.Length / 1MB), 1)
          $jreSize = (Get-ChildItem -Recurse "target\custom-jre" -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum
          $jreSizeInMB = if ($jreSize) { [math]::Round(($jreSize / 1MB), 1) } else { "Unknown" }
          $isSigned = if ($env:WIN_SIGNING_CERTIFICATE) { "Yes" } else { "No" }
          
          echo "## Windows Installer Build Results ðŸªŸ" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "| Component | Details |" >> $env:GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Installer Package | $($msiFile.Name) |" >> $env:GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Package Size | $sizeInMB MB |" >> $env:GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Custom JRE Size | $jreSizeInMB MB |" >> $env:GITHUB_STEP_SUMMARY
          echo "| ðŸ” Code Signed | $isSigned |" >> $env:GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build Platform | Windows (windows-latest) |" >> $env:GITHUB_STEP_SUMMARY
          echo "| â˜• Java Version | 21 (Temurin) |" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Installation Instructions" >> $env:GITHUB_STEP_SUMMARY
          echo "1. Download the `.msi` file from the artifacts" >> $env:GITHUB_STEP_SUMMARY
          echo "2. Double-click to run the installer" >> $env:GITHUB_STEP_SUMMARY
          echo "3. Follow the installation wizard" >> $env:GITHUB_STEP_SUMMARY
          echo "4. The application will start automatically and appear in your system tray" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Features" >> $env:GITHUB_STEP_SUMMARY
          echo "- âœ… Embedded Java Runtime (no separate Java installation required)" >> $env:GITHUB_STEP_SUMMARY
          echo "- âœ… Desktop shortcut and Start Menu entry" >> $env:GITHUB_STEP_SUMMARY
          echo "- âœ… Windows system tray integration" >> $env:GITHUB_STEP_SUMMARY
          echo "- âœ… Automatic startup configuration option" >> $env:GITHUB_STEP_SUMMARY
          echo "- âœ… Standard Windows installer with uninstall support" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### ðŸ—‘ï¸ Uninstallation" >> $env:GITHUB_STEP_SUMMARY
          echo "Use **Add or Remove Programs** in Windows Settings or run:" >> $env:GITHUB_STEP_SUMMARY
          echo '```cmd' >> $env:GITHUB_STEP_SUMMARY
          echo "msiexec /x `"$($msiFile.Name)`"" >> $env:GITHUB_STEP_SUMMARY
          echo '```' >> $env:GITHUB_STEP_SUMMARY
        } else {
          echo "## Windows Installer Build Failed âŒ" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "The Windows installer build did not complete successfully." >> $env:GITHUB_STEP_SUMMARY
          echo "Please check the build logs for details." >> $env:GITHUB_STEP_SUMMARY
        }
      env:
        WIN_SIGNING_CERTIFICATE: ${{ secrets.WIN_SIGNING_CERTIFICATE }}
        
    - name: Release
      if: startsWith(github.ref, 'refs/tags/') && github.event_name != 'pull_request'
      uses: softprops/action-gh-release@v2
      with:
        files: target/installer/*.msi
        body: |
          ## Windows Installer Package ðŸªŸ
          
          This release includes a self-contained Windows installer package with embedded Java Runtime.
          
          ### Installation
          1. Download the `.msi` file
          2. Double-click to run the installer  
          3. Follow the installation wizard
          4. The application will automatically start and appear in your system tray
          
          ### Features
          - âœ… No Java installation required (embedded JRE)
          - âœ… Desktop shortcut and Start Menu integration
          - âœ… Native Windows system tray integration  
          - âœ… Standard MSI installer with proper uninstall support
          - âœ… Code signed for security (release builds)
          - âœ… Automatic startup configuration
          
          ### System Requirements
          - Windows 10 version 1809 or later (64-bit)
          - ~100 MB available disk space
          - Administrative privileges for installation
          
          ### Security
          Release builds are code signed with a trusted certificate for enhanced security and Windows Defender compatibility.